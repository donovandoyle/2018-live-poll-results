---
title: "Problem Set 7"
author: "Keeley MacAfee, Connor Sakmar, Donovan Doyle, Annabelle Paterson"
date: "11/18/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(plyr)
library(tidyverse)
library(foreign)
library(readxl)
library(stringr)
library(fs)
library(kableExtra)
library(formattable)
library(lubridate)
library(knitr)
library(janitor)
library(stringr)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
download.file("https://goo.gl/ZRCBda",
              destfile = "Polls.zip",
              quiet = TRUE,
              mode = "wb")

unzip("Polls.zip")

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
x <- dir_ls("2018-live-poll-results-master/data")

polls <- map_dfr(x, read_csv, .id = "source")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
download.file(url = "https://d1b10bmlvqabco.cloudfront.net/attach/jkjtds7xjxd3jy/jlr7wvzsace3kp/joc6wbypyxy7/mt_2_results.csv",
              destfile = "mt_2_results.csv")

schroeder_data <- read_csv("mt_2_results.csv")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}

polls_separate <-polls %>%
  select(source, response, ager, educ, gender, race_eth, race_edu, final_weight) %>%
  mutate(neat = str_split(source, "-")) %>%
  separate(neat, into = c("c", "year", "live", "poll", "results", "master", "data", "elections", "poll_again", "state_district", "wave")) %>%
  select(state_district, response, wave, ager, educ, gender, race_eth, race_edu, final_weight)

polls_clean <- polls_separate %>%
  separate(state_district, into = c("state", "district"), sep = 2) %>%
  filter(race_eth != "[DO NOT READ] Don't know/Refused") %>%
  filter(race_edu != "[DO NOT READ] Don't know/Refused") %>%
  filter(educ != "[DO NOT READ] Don't know/Refused") %>%
  filter(educ != "[DO NOT READ] Refused") %>%
  filter(ager != "[DO NOT READ] Don't know/Refused") %>%
  filter(ager != "[DO NOT READ] Refused") %>%
  filter(gender != "[DO NOT READ] Don't know/Refused") %>%
  filter(wave == "3") %>%
  filter(district != "sen") %>%
  filter(district != "gov") %>% 
  mutate(state = str_to_upper(state)) %>%
  unite(state_district, state:district, sep = "-")


write_rds(polls_clean, "ps_7/polls_clean.rds", compress = "none")


```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
results <- schroeder_data %>%
  filter(district != "sen") %>%
  filter(district != "gov") %>%
   mutate(win_party = case_when(win_party == "R" ~ "Republican", win_party == "UNDECIDED" ~ "Undecided", win_party == "D" ~ "Democrat")) %>%
  unite(state_district, state:district, sep = "-")
```


```{r}


polls_clean2 <- polls_clean %>%
  group_by(response, state_district) %>%
  tally(wt = final_weight) %>%
  spread(response, n, fill = 0) %>%
  mutate(total = Dem + Rep + Und + 3 + 4 + 5 + 6) %>%
  mutate(Dem_per = (Dem/total), Rep_per = (Rep/total))

joined <- left_join(results, polls_clean2, by = "state_district") %>%
  select(state_district, win_party, dem_votes, rep_votes, other_votes, total, Dem_per, Rep_per) %>%
  mutate(total_true = (dem_votes + rep_votes + other_votes)) %>%
  mutate(dem_true = (dem_votes / total_true), rep_true = (rep_votes / total_true)) %>%
  filter(!is.na(total)) %>%
  separate(state_district, into = c("state", "district"), sep = 2)
  
fit <- lm(rep_true ~ Rep_per, data = joined) %>% 
  
  joined %>%  cor(rep_true, Rep_per)

summary(fit)

write_rds(joined, "ps_7/joined_data.rds", compress = "none")



fit <- joined %>% 
  mutate(rep_true = parse_number(rep_true), Rep_per = parse_number(Rep_per)) %>%
  lm(rep_true ~ Rep_per, data = joined)

?cor


```

```

